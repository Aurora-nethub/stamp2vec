================================================================================
                    STAMP2VEC FastAPI æœåŠ¡è®¾è®¡æ–‡æ¡£
================================================================================

1. é¡¹ç›®æ¶æ„æ¦‚è§ˆ
================================================================================

é‡æ–°è§„åˆ’çš„é¡¹ç›®ç»“æ„:

stamp2vec/
â”œâ”€â”€ seal_embedding_api/          # FastAPI åº”ç”¨æ ¸å¿ƒç›®å½•ï¼ˆç”Ÿäº§ä»£ç ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                  # ä¸»åº”ç”¨å…¥å£ï¼Œåˆå§‹åŒ– FastAPI å’Œå…¨å±€æ¨¡å‹
â”‚   â”œâ”€â”€ models.py                # Pydantic è¯·æ±‚/å“åº”æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ health.py            # Health æ£€æŸ¥ç«¯ç‚¹
â”‚   â”‚   â””â”€â”€ pipeline.py          # æ£€æµ‹ + åµŒå…¥ + ç›¸ä¼¼åº¦æœç´¢ç«¯ç‚¹
â”‚   â””â”€â”€ core/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ embedding_service.py    # å°è£… embedding æå–é€»è¾‘
â”‚       â”œâ”€â”€ detection_service.py    # å°è£…æ£€æµ‹é€»è¾‘
â”‚       â”œâ”€â”€ storage.py              # æœ¬åœ°å­˜å‚¨ï¼ˆåµŒå…¥å‘é‡å’Œå…ƒæ•°æ®ï¼‰
â”‚       â””â”€â”€ similarity_service.py    # ç›¸ä¼¼åº¦è®¡ç®—é€»è¾‘
â”‚
â”œâ”€â”€ train/                       # è®­ç»ƒå’Œå®éªŒç›¸å…³ä»£ç ï¼ˆéç”Ÿäº§ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ model.py                 # åŸæ¥çš„ model.pyï¼ˆå®šä¹‰ SealEmbeddingNetï¼‰
â”‚   â”œâ”€â”€ detect.py                # åŸæ¥çš„ detect.pyï¼ˆseal æ£€æµ‹é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ verify.py                # åŸæ¥çš„ verify.pyï¼ˆç¦»çº¿éªŒè¯è„šæœ¬ï¼‰
â”‚   â”œâ”€â”€ generate_dataset.py      # åŸæ¥çš„ generate_dataset.py
â”‚   â”œâ”€â”€ dataset.py               # åŸæ¥çš„ dataset.py
â”‚   â”œâ”€â”€ export.py                # åŸæ¥çš„ export.py
â”‚   â””â”€â”€ train.py                 # åŸæ¥çš„ train.py
â”‚
â”œâ”€â”€ models/                      # æ¨¡å‹æ–‡ä»¶å’Œé…ç½®
â”‚   â””â”€â”€ seal_pkg_v1/             # åŸ exported/seal_pkg_v1
â”‚       â”œâ”€â”€ config.json
â”‚       â”œâ”€â”€ manifest.json
â”‚       â””â”€â”€ model.pt
â”‚
â”œâ”€â”€ database/                    # æ•°æ®åº“å­˜å‚¨ç›®å½•
â”‚   â”œâ”€â”€ embeddings/
â”‚   â”‚   â”œâ”€â”€ embeddings.pkl       # æ‰€æœ‰ seal embedding æ˜ å°„
â”‚   â”‚   â”œâ”€â”€ metadata.json        # seal å…ƒæ•°æ®ï¼ˆdoc_id, timestamp, crop_pathï¼‰
â”‚   â”‚   â””â”€â”€ crops/               # è£å‰ªçš„å°ç« å›¾åƒ
â”‚   â”‚       â”œâ”€â”€ doc_001_seal_0.png
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ index.json               # å¯é€‰ï¼šåŠ é€ŸæŸ¥è¯¢çš„ç´¢å¼•
â”‚
â”œâ”€â”€ data/                        # æ•°æ®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ candidate/
â”‚   â””â”€â”€ query/
â”‚
â”œâ”€â”€ config/                      # âœ… æ–°å¢ï¼šé…ç½®æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ api_config.json          # API è¿è¡Œæ—¶é…ç½®
â”‚
â”œâ”€â”€ scripts/                     # å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ extract_test_image.py    # ç”Ÿæˆ health check æµ‹è¯•å›¾åƒ
â”‚   â””â”€â”€ run_server.py            # å¯åŠ¨ FastAPI æœåŠ¡è„šæœ¬
â”‚
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ API_DESIGN.txt               # æœ¬æ–‡ä»¶
â””â”€â”€ __pycache__/

2. é…ç½®ç®¡ç†
================================================================================

é…ç½®æ–‡ä»¶: config/api_config.json

{
  "embedding_model": {
    "pkg_dir": "models/seal_pkg_v1",
    "device": "cpu"
  },
  "detection_model": {
    "model_name": "PP-DocLayout-L",
    "batch_size": 1
  },
  "batch_processing": {
    "embedding_batch_size": 32,
    "max_concurrent_tasks": 4
  },
  "storage": {
    "base_dir": "database/embeddings"
  },
  "similarity_search": {
    "default_top_k": 3,
    "confidence_thresholds": {
      "high": 0.9,
      "medium": 0.7
    }
  }
}

è¯´æ˜:
  - embedding_model.pkg_dir: SealEmbeddingNet æ¨¡å‹åŒ…ä½ç½®
  - detection_model.model_name: LayoutDetection æ¨¡å‹åç§°ï¼ˆPP-DocLayout-L ç­‰ï¼‰
  - detection_model.batch_size: æ£€æµ‹æ—¶çš„ batch sizeï¼ˆé€šå¸¸ä¸º 1ï¼‰
  - batch_processing.embedding_batch_size: åµŒå…¥æå–çš„ batch å¤§å°ï¼ˆâ‰¤32ï¼ŒCPU ä¼˜åŒ–ï¼‰
  - batch_processing.max_concurrent_tasks: æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
  - confidence_thresholds: ç”¨äºè‡ªåŠ¨åˆ¤æ–­ confidence ç­‰çº§


3. å…¨å±€æ¨¡å‹ç®¡ç†ï¼ˆåŒæ¨¡å‹æŒä¹…åŒ–ï¼‰
================================================================================

å¯åŠ¨æ—¶åŠ è½½ä¸¤ä¸ªæ¨¡å‹ï¼š

æ¨¡å‹ 1: SealEmbeddingNet (åµŒå…¥æå–)
  - åŠ è½½ä½ç½®: models/seal_pkg_v1
  - å‚æ•°æ¥æº: config/api_config.json â†’ embedding_model
  - è®¾å¤‡: CPUï¼ˆtorch.device("cpu")ï¼‰
  - æ¨¡å¼: eval() + @torch.no_grad()
  - ç»´åº¦: 768
  - çŠ¶æ€: å…¨ç¨‹é©»ç•™å†…å­˜ï¼ˆå•ä¾‹ï¼‰

æ¨¡å‹ 2: LayoutDetection (å°ç« æ£€æµ‹)
  - åŠ è½½ä½ç½®: å†…å­˜ï¼ˆPaddleOCR è‡ªåŠ¨ç®¡ç†ï¼‰
  - å‚æ•°æ¥æº: config/api_config.json â†’ detection_model
  - æ¨¡å‹åç§°: "PP-DocLayout-L"ï¼ˆå¯é…ç½®ï¼‰
  - Batch size: 1ï¼ˆå›ºå®šï¼Œå¯ä»é…ç½®è¯»å–ï¼‰
  - åˆå§‹åŒ–æ—¶æœº: startup event
  - çŠ¶æ€: å…¨ç¨‹é©»ç•™å†…å­˜ï¼ˆå•ä¾‹ï¼‰
  - æ—¥å¿—: ä½¿ç”¨ _suppress_host_check_logs() æŠ‘åˆ¶å™ªå£°

åˆå§‹åŒ–æµç¨‹:
  1. è¯»å– config/api_config.json
  2. ä½¿ç”¨ embedding_model é…ç½®åŠ è½½ SealEmbeddingNet
  3. ä½¿ç”¨ detection_model é…ç½®åˆå§‹åŒ– LayoutDetection
  4. ä¸¤ä¸ªæ¨¡å‹å­˜å‚¨åœ¨å…¨å±€çŠ¶æ€ app_state ä¸­
  5. æ‰€æœ‰è¯·æ±‚å…±äº«è¿™ä¸¤ä¸ªæ¨¡å‹å®ä¾‹


4. æ¥å£è®¾è®¡ - å…¨å¼‚æ­¥æ”¯æŒ

================================================================================

ğŸ”„ æ‰€æœ‰ç«¯ç‚¹å‡ä¸ºå¼‚æ­¥ï¼ˆasync defï¼‰ï¼Œæ”¯æŒé«˜å¹¶å‘å¤„ç†

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¥å£ 1: Health æ£€æŸ¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è·¯ç”±:        GET /health
â”‚ å¼‚æ­¥:        âœ… async def
â”‚ åŠŸèƒ½:        éªŒè¯æ¨¡å‹æ˜¯å¦æ­£å¸¸åŠ è½½ï¼Œé€šè¿‡ embedding æµç¨‹æµ‹è¯•
â”‚ è¯·æ±‚ä½“:      æ— 
â”‚ å“åº”ç¤ºä¾‹:
â”‚   {
â”‚     "status": "healthy",
â”‚     "model_loaded": true,
â”‚     "embedding_dim": 768,
â”‚     "message": "Model is ready"
â”‚   }
â”‚
â”‚ å®ç°é€»è¾‘:
â”‚   1. æ£€æŸ¥å…¨å±€æ¨¡å‹æ˜¯å¦åŠ è½½
â”‚   2. åˆ›å»ºä¸€ä¸ªæµ‹è¯•å›¾åƒï¼ˆæˆ–æ¥æ”¶ä¸€ä¸ªå° base64 å›¾åƒï¼‰
â”‚   3. è¿è¡Œ embedding æµç¨‹ï¼ˆtransform + forward passï¼‰
â”‚   4. è¿”å›æˆåŠŸçŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¥å£ 2: æ£€æµ‹ + åµŒå…¥ Ingestï¼ˆæ”¯æŒ base64 ä¸æ–‡ä»¶ä¸Šä¼ ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è·¯ç”±:        POST /seals/ingest_base64
â”‚              POST /seals/ingest_upload
â”‚ å¼‚æ­¥:        ? async def
â”‚ åŠŸèƒ½:        è¾“å…¥å›¾åƒ -> detect (PaddleOCR LayoutDetection) 
â”‚              -> è£å‰ªå°ç«  -> ç”ŸæˆåµŒå…¥ -> å­˜å‚¨
â”‚ 
â”‚ æ”¯æŒçš„è¾“å…¥æ–¹å¼:
â”‚   æ–¹å¼ 1: Base64 JSON
â”‚   æ–¹å¼ 2: æœ¬åœ°æ–‡ä»¶ä¸Šä¼ ï¼ˆmultipart/form-dataï¼‰
â”‚
â”‚ è¯·æ±‚ä½“ (Base64 JSON):
â”‚   {
â”‚     "doc_id": "doc_001",
â”‚     "images_b64": ["<base64-1>", "<base64-2>"],
â”‚     "save_crops": true
â”‚   }
â”‚
â”‚ è¯·æ±‚ä½“ (Form Data):
â”‚   - images: List[UploadFile]    # å•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶
â”‚   - doc_id: str                 # æ–‡æ¡£ ID
â”‚   - save_crops: bool            # æ˜¯å¦ä¿å­˜è£å‰ªçš„å°ç« å›¾åƒ
â”‚
â”‚ å“åº”ç¤ºä¾‹:
â”‚   {
â”‚     "doc_id": "doc_001",
â”‚     "seals_detected": 2,
â”‚     "embeddings_stored": [
â”‚       {
â”‚         "seal_id": "doc_001_seal_0",
â”‚         "embedding_dim": 768,
â”‚         "image_crop_saved": true
â”‚       },
â”‚       {
â”‚         "seal_id": "doc_001_seal_1",
â”‚         "embedding_dim": 768,
â”‚         "image_crop_saved": true
â”‚       }
â”‚     ],
â”‚     "status": "success"
â”‚   }
â”‚
â”‚ å®ç°é€»è¾‘:
â”‚   1. æ¥æ”¶å•ä¸ªæˆ–å¤šä¸ªå›¾åƒæ–‡ä»¶ï¼ˆæ”¯æŒ base64 æˆ–ç›´æ¥æ–‡ä»¶ä¸Šä¼ ï¼‰
â”‚   2. æŒ‰ batch_size=32 åˆ†ç»„å¤„ç†ï¼ˆå¼‚æ­¥å¹¶å‘ï¼‰
â”‚   3. å¯¹æ¯ä¸ªå›¾åƒï¼š
â”‚      a. è°ƒç”¨ detect.crop_seals() è·å–å°ç« è£å‰ª
â”‚      b. æ‰¹é‡æå– embeddingï¼ˆ<= 32 ä¸ªï¼‰
â”‚      c. å­˜å‚¨ embedding å’Œå…ƒæ•°æ®
â”‚   4. èšåˆç»“æœè¿”å›
â”‚
â”‚ æœ¬åœ°å­˜å‚¨æ ¼å¼:
â”‚   database/embeddings/
â”‚   â”œâ”€â”€ embeddings.pkl       # æ‰€æœ‰ seal_id -> embedding æ˜ å°„
â”‚   â”œâ”€â”€ metadata.json        # seal_id -> {doc_id, timestamp, crop_path}
â”‚   â””â”€â”€ crops/
â”‚       â”œâ”€â”€ doc_001_seal_0.png
â”‚       â”œâ”€â”€ doc_001_seal_1.png
â”‚       â””â”€â”€ ...
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¥å£ 3: ç›¸ä¼¼åº¦æœç´¢ (åŸºäºå·²å­˜å‚¨çš„åµŒå…¥ + å¢å¼ºè¿”å›ä¿¡æ¯)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è·¯ç”±:        POST /seals/search
â”‚ å¼‚æ­¥:        ? async def
â”‚ åŠŸèƒ½:        è¾“å…¥å›¾åƒæˆ– seal_id -> è®¡ç®—ä¸å­˜å‚¨çš„åµŒå…¥ç›¸ä¼¼åº¦ -> è¿”å› top-1, top-3 + é™„åŠ ä¿¡æ¯
â”‚
â”‚ è¯·æ±‚ä½“ (å¤šç§è¾“å…¥æ–¹å¼):
â”‚   æ–¹å¼ A: Base64 å›¾åƒ
â”‚   {
â”‚     "image_b64": "<base64-encoded-image>",
â”‚     "top_k": 3,  # å¯é€‰ï¼Œé»˜è®¤ 3ï¼Œä½†è‡³å°‘è¿”å› top-1
â”‚     "threshold": 0.5  # å¯é€‰ï¼Œç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤
â”‚   }
â”‚
â”‚   æ–¹å¼ B: æŸ¥è¯¢å·²æœ‰å°ç«  ID
â”‚   {
â”‚     "query_seal_id": "doc_001_seal_0",
â”‚     "top_k": 3,
â”‚     "threshold": 0.5
â”‚   }
â”‚
â”‚ å“åº”ç¤ºä¾‹ï¼ˆå¢å¼ºè¿”å›æ ¼å¼ï¼‰:
â”‚   {
â”‚     "query_seal_id": "query_temp_001",
â”‚     "query_metadata": {
â”‚       "source": "image",  # "image" | "seal_id"
â”‚       "timestamp": "2026-01-27T12:00:00",
â”‚       "embedding_dim": 768
â”‚     },
â”‚     "top_1": {
â”‚       "seal_id": "doc_002_seal_1",
â”‚       "doc_id": "doc_002",
â”‚       "similarity_score": 0.9523,
â”‚       "rank": 1,
â”‚       "confidence": "high",  # "high"(>=0.9), "medium"(0.7-0.9), "low"(<0.7)
â”‚       "crop_path": "database/embeddings/crops/doc_002_seal_1.png"
â”‚     },
â”‚     "top_3": [
â”‚       {
â”‚         "seal_id": "doc_002_seal_1",
â”‚         "doc_id": "doc_002",
â”‚         "similarity_score": 0.9523,
â”‚         "rank": 1,
â”‚         "confidence": "high",
â”‚         "crop_path": "database/embeddings/crops/doc_002_seal_1.png"
â”‚       },
â”‚       {
â”‚         "seal_id": "doc_003_seal_0",
â”‚         "doc_id": "doc_003",
â”‚         "similarity_score": 0.8712,
â”‚         "rank": 2,
â”‚         "confidence": "medium",
â”‚         "crop_path": "database/embeddings/crops/doc_003_seal_0.png"
â”‚       },
â”‚       {
â”‚         "seal_id": "doc_001_seal_2",
â”‚         "doc_id": "doc_001",
â”‚         "similarity_score": 0.7834,
â”‚         "rank": 3,
â”‚         "confidence": "medium",
â”‚         "crop_path": "database/embeddings/crops/doc_001_seal_2.png"
â”‚       }
â”‚     ],
â”‚     "statistics": {
â”‚       "total_in_database": 25,
â”‚       "returned_count": 3,
â”‚       "filtered_by_threshold": 0,  # è¢«é˜ˆå€¼è¿‡æ»¤æ‰çš„æ•°é‡
â”‚       "processing_time_ms": 145
â”‚     },
â”‚     "status": "success"
â”‚   }
â”‚
â”‚ å®ç°é€»è¾‘:
â”‚   1. è·å–æŸ¥è¯¢å°ç« çš„ embeddingï¼š
â”‚      - è‹¥è¾“å…¥æ˜¯å›¾åƒï¼Œå…ˆåš ingestï¼ˆå‡è®¾å•ä¸ªå°ç« ï¼‰
â”‚      - è‹¥è¾“å…¥æ˜¯ seal_idï¼Œä»å­˜å‚¨ä¸­è¯»å–
â”‚      - å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡
â”‚   2. åŠ è½½æ‰€æœ‰å­˜å‚¨çš„ embeddingï¼ˆå¯è€ƒè™‘ç¼“å­˜ï¼‰
â”‚   3. è®¡ç®—ç›¸ä¼¼åº¦ (ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œå› ä¸ºå·² L2-normalize)ï¼Œå‘é‡åŒ–è®¡ç®—æå‡æ•ˆç‡
â”‚   4. æ’åºå¹¶å– top-kï¼ˆæˆ–å…¨éƒ¨ï¼Œå¦‚æœæ•°æ®åº“ä¸è¶³ï¼‰
â”‚   5. åº”ç”¨ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤ï¼ˆå¦‚æœæä¾›ï¼‰
â”‚   6. é™„åŠ å…ƒæ•°æ®ï¼šcrop_pathã€confidence çº§åˆ«ç­‰
â”‚   7. åˆ†åˆ«è¿”å› top-1 å’Œ top-3 ä¾›ä¸åŒç”¨åœºæ™¯ä½¿ç”¨
â”‚   8. è¿”å›ç»Ÿè®¡ä¿¡æ¯ä¾¿äºè°ƒè¯•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


4. æ•°æ®å­˜å‚¨æ–¹æ¡ˆï¼ˆCPU ä¼˜åŒ–ï¼‰
================================================================================

å­˜å‚¨ä½ç½®: database/embeddings/

æ•°æ®æ ¼å¼:
  1. åµŒå…¥å‘é‡å­˜å‚¨:
     - æ–‡ä»¶: database/embeddings/embeddings.pkl
     - æ ¼å¼: Python pickle dictionary
     - ç»“æ„: { "seal_id": numpy.ndarray(768,) }
     - è¯´æ˜: æ‰€æœ‰ seal_id -> embedding æ˜ å°„ï¼ŒD = 768

  2. å…ƒæ•°æ®å­˜å‚¨:
     - æ–‡ä»¶: database/embeddings/metadata.json
     - æ ¼å¼: JSON
     - ç»“æ„:
       {
         "seal_id_1": {
           "doc_id": "doc_001",
           "timestamp": "2024-01-27T10:30:45",
           "crop_path": "database/embeddings/crops/doc_001_seal_0.png"
         },
         ...
       }

  3. è£å‰ªå›¾åƒå­˜å‚¨:
     - ç›®å½•: database/embeddings/crops/
     - å‘½å: {doc_id}_seal_{idx}.png
     - ç”¨é€”: å¯è§†åŒ–å’ŒéªŒè¯

è®¿é—®æ¥å£:
  - load_embeddings(): åŠ è½½ pkl æ–‡ä»¶
  - save_embedding(seal_id, emb, doc_id): æ·»åŠ æ–° embedding
  - get_embedding(seal_id): è¯»å–å•ä¸ª embedding
  - list_all_embeddings(): è¿”å›æ‰€æœ‰ seal_id å’Œå¯¹åº”å…ƒæ•°æ®


5. æ ¸å¿ƒæ¨¡å—èŒè´£åˆ’åˆ†
================================================================================

main.py:
  - FastAPI åº”ç”¨åˆå§‹åŒ–ï¼ˆasync è¿è¡Œï¼‰
  - å¯åŠ¨äº‹ä»¶ï¼š
    1. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿï¼ˆlogger_config.pyï¼‰
    2. è¯»å– config/api_config.json
    3. åŠ è½½ SealEmbeddingNet æ¨¡å‹
    4. åˆå§‹åŒ– LayoutDetection æ¨¡å‹
    5. åˆå§‹åŒ–å­˜å‚¨å’Œå…¶ä»–æœåŠ¡
  - è·¯ç”±æ³¨å†Œ
  - å¯¼å…¥: from train.model import SealEmbeddingNet

logger_config.py:
  - LoggerConfig ç±»
  - åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿï¼ˆConsole + File Handlerï¼‰
  - è®¾ç½®æ—¥å¿—çº§åˆ«ã€æ ¼å¼ã€æ–‡ä»¶è½®è½¬
  - ä¸ºå„ä¸ªæ¨¡å—è¿”å›å·²é…ç½®çš„ logger

config_loader.py:
  - ConfigLoader ç±»
  - è¯»å– config/api_config.json
  - ç±»å‹è½¬æ¢ã€é»˜è®¤å€¼å¤„ç†
  - å‚æ•°éªŒè¯ï¼ˆå¦‚ batch_size èŒƒå›´æ£€æŸ¥ï¼‰

models.py:
  - Pydantic æ•°æ®æ¨¡å‹
  - HealthCheckResponse
  - IngestRequest / IngestResponse (æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œ base64)
  - SimilaritySearchRequest / SimilaritySearchResponse (å¢å¼ºæ ¼å¼)
  - æ”¯æŒéªŒè¯å’Œç±»å‹è½¬æ¢

core/embedding_service.py:
  - EmbeddingService ç±»
  - async æ–¹æ³•ï¼šextract_embedding(image), extract_embeddings_batch(images)
  - æ”¯æŒå¹¶å‘å¤„ç†
  - ä»é…ç½®è¯»å– batch_size

core/detection_service.py:
  - DetectionService ç±»
  - åœ¨ __init__ ä¸­åˆå§‹åŒ– LayoutDetection æ¨¡å‹ï¼ˆä¸€æ¬¡æ€§ï¼‰
  - async æ–¹æ³•ï¼šdetect_seals(image) -> List[PIL.Image]
  - ä»é…ç½®è¯»å– model_name å’Œ batch_size
  - ä½¿ç”¨ _suppress_host_check_logs() æŠ‘åˆ¶æ—¥å¿—

core/storage.py:
  - Storage ç±»
  - æ–¹æ³•ï¼šsave_embedding, load_embeddings, get_embedding, list_all_embeddings
  - çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨ Lock å¤„ç†å¹¶å‘ I/Oï¼‰
  - ä»é…ç½®è¯»å– base_dir

core/similarity_service.py:
  - SimilarityService ç±»
  - å‘é‡åŒ–ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆnumpy/torchï¼‰
  - async æ–¹æ³•æ”¯æŒå¹¶å‘æŸ¥è¯¢
  - ä»é…ç½®è¯»å– confidence_thresholds

api/health.py:
  - Router: GET /health
  - async def
  - éªŒè¯ä¸¤ä¸ªæ¨¡å‹æ˜¯å¦åŠ è½½

api/pipeline.py:
  - Router: POST /seals/ingest_base64 (base64 æ‰¹é‡)
  - Router: POST /seals/ingest_upload (æ–‡ä»¶ä¸Šä¼ æ‰¹é‡)
  - Router: POST /seals/search (å¢å¼ºè¿”å›ä¿¡æ¯)
  - ä¸¤ä¸ªç«¯ç‚¹éƒ½æ˜¯ async
  - ä½¿ç”¨é…ç½®çš„ batch_size å’Œ max_concurrent_tasks

train/ ç›®å½•ï¼ˆä¿ç•™ï¼Œä¸ç›´æ¥è°ƒç”¨ï¼‰:
  - model.py: åŸ SealEmbeddingNet å®šä¹‰
  - detect.py: åŸæ£€æµ‹é€»è¾‘ï¼ˆå¤ç”¨äº DetectionServiceï¼‰
  - verify.py: åŸéªŒè¯è„šæœ¬ï¼ˆç¦»çº¿ä½¿ç”¨ï¼‰
  - å…¶ä»–: è®­ç»ƒç›¸å…³è„šæœ¬ï¼ˆä¸è°ƒç”¨ï¼‰


6. å¼‚æ­¥ä¸æ‰¹å¤„ç†å®ç°ç»†èŠ‚ï¼ˆæ¨¡å‹æŒä¹…åŒ–ï¼‰
================================================================================

ğŸ”„ å¼‚æ­¥è®¾è®¡åŸåˆ™:
  - æ‰€æœ‰è·¯ç”±éƒ½æ˜¯ async def
  - I/O æ“ä½œï¼ˆæ–‡ä»¶ä¸Šä¼ ã€å­˜å‚¨è¯»å†™ï¼‰ä½¿ç”¨å¼‚æ­¥æ–¹å¼
  - CPU å¯†é›†æ“ä½œï¼ˆembedding è®¡ç®—ï¼‰ä½¿ç”¨ asyncio.to_thread æˆ– ThreadPoolExecutor åŒ…è£…
  - ä¸é˜»å¡äº‹ä»¶å¾ªç¯

ğŸ—ï¸ æ¨¡å‹æŒä¹…åŒ–æ¶æ„ï¼ˆåŒæ¨¡å‹å•ä¾‹ï¼‰:

  åº”ç”¨å¯åŠ¨æµç¨‹:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. ConfigLoader.load_config("config/api_config.json") â”‚
  â”‚    è¯»å–æ‰€æœ‰å‚æ•°ï¼šembedding_modelã€detection_modelç­‰  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 2. æ¨¡å‹ A: SealEmbeddingNet (åµŒå…¥æå–)                 â”‚
  â”‚    - åŠ è½½: SealEmbeddingNet.from_package()            â”‚
  â”‚    - æ¥æº: models/seal_pkg_v1                        â”‚
  â”‚    - é…ç½®: config.embedding_model.pkg_dir, device    â”‚
  â”‚    - çŠ¶æ€: é©»ç•™å†…å­˜ï¼ˆå•ä¾‹ï¼‰ï¼Œå…¨ç¨‹å¯ç”¨                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 3. æ¨¡å‹ B: LayoutDetection (å°ç« æ£€æµ‹)                 â”‚
  â”‚    - åˆå§‹åŒ–: DetectionService.__init__()             â”‚
  â”‚    - æ¨¡å‹: LayoutDetection(model_name=...)           â”‚
  â”‚    - é…ç½®: config.detection_model.model_name         â”‚
  â”‚    - batch_size: config.detection_model.batch_size   â”‚
  â”‚    - çŠ¶æ€: é©»ç•™å†…å­˜ï¼ˆå•ä¾‹ï¼‰ï¼Œå…¨ç¨‹å¯ç”¨                â”‚
  â”‚    - æ—¥å¿—: ä½¿ç”¨ _suppress_host_check_logs() æŠ‘åˆ¶    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 4. å…¶ä»–æœåŠ¡åˆå§‹åŒ–                                     â”‚
  â”‚    - Storage (base_dir from config)                  â”‚
  â”‚    - SimilarityService (thresholds from config)      â”‚
  â”‚    - EmbeddingService (batch_size from config)       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 5. å…¨å±€çŠ¶æ€ app_state (å•ä¾‹ç®¡ç†)                       â”‚
  â”‚    app_state = {                                     â”‚
  â”‚      "embedding_model": embedding_model,             â”‚
  â”‚      "detection_service": detection_service,         â”‚
  â”‚      "storage": storage,                             â”‚
  â”‚      "similarity_service": similarity_service,       â”‚
  â”‚      "config": config,                               â”‚
  â”‚      "device": device                                â”‚
  â”‚    }                                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ æœåŠ¡å™¨å‡†å¤‡å°±ç»ªï¼Œä¸¤ä¸ªæ¨¡å‹å¸¸é©»å†…å­˜

  è¯·æ±‚å¤„ç†æµç¨‹ï¼ˆä¸é‡æ–°åŠ è½½æ¨¡å‹ï¼‰:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ£€æµ‹æ­¥éª¤:                                             â”‚
  â”‚   image_file â†’ detection_service.detect_seals()     â”‚
  â”‚             â†’ ä½¿ç”¨å†…å­˜ä¸­çš„ LayoutDetection æ¨¡å‹      â”‚
  â”‚             â†’ è¿”å› List[PIL.Image] (è£å‰ªå°ç« )       â”‚
  â”‚             â† batch_size ä» config è¯»å–             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ åµŒå…¥æ­¥éª¤:                                             â”‚
  â”‚   seals â†’ embedding_service.extract_embeddings_batch()
  â”‚        â†’ ä½¿ç”¨å†…å­˜ä¸­çš„ SealEmbeddingNet æ¨¡å‹         â”‚
  â”‚        â†’ batch_size: config.batch_processing.embedding_batch_size
  â”‚        â†’ è¿”å› numpy.ndarray (N, 768)                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ å­˜å‚¨æ­¥éª¤:                                             â”‚
  â”‚   embeddings â†’ storage.save_embedding()             â”‚
  â”‚            â†’ çº¿ç¨‹å®‰å…¨ I/O (Lock ä¿æŠ¤)               â”‚
  â”‚            â†’ ä¿å­˜åˆ° database/embeddings/             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“¦ æ‰¹é‡å¤„ç†æµç¨‹ (ingest_base64 / ingest_upload):
  1. æ¥æ”¶ List[UploadFile] æˆ– List[base64]
  2. å¹¶å‘ä¸Šä¼ /è¯»å–å›¾åƒ
  3. å¾ªç¯æ£€æµ‹æ¯ä¸ªå›¾åƒ â†’ æ”¶é›†æ‰€æœ‰è£å‰ª
  4. æŒ‰ batch_size åˆ†ç»„ï¼ˆæ¥è‡ª configï¼‰ï¼š
     - embedding_batch_size: config.batch_processing.embedding_batch_size (â‰¤32)
     - max_concurrent_tasks: config.batch_processing.max_concurrent_tasks
  5. å¼‚æ­¥å¹¶å‘å¤„ç† batchï¼š
     async for batch in batches:
       embeddings = await embedding_service.extract_embeddings_batch(batch)
  6. å­˜å‚¨æ‰€æœ‰ç»“æœ
  7. è¿”å›èšåˆç»“æœ

ğŸ”§ é…ç½®é©±åŠ¨çš„å…³é”®å‚æ•°:

  config/api_config.json:
  {
    "embedding_model": {
      "pkg_dir": "models/seal_pkg_v1",
      "device": "cpu"
    },
    "detection_model": {
      "model_name": "PP-DocLayout-L",  # å¯åˆ‡æ¢ S/M/L
      "batch_size": 1
    },
    "batch_processing": {
      "embedding_batch_size": 32,     # <= 32ï¼ˆCPU ä¼˜åŒ–ï¼‰
      "max_concurrent_tasks": 4      # å¹¶å‘ batch æ•°
    },
    ...
  }

  è¿è¡Œæ—¶ä½¿ç”¨:
  - æ¨¡å‹ A çš„ batch_size: config.detection_model.batch_size
  - æ¨¡å‹ B çš„ batch_size: config.batch_processing.embedding_batch_size
  - å¹¶å‘åº¦: config.batch_processing.max_concurrent_tasks
  - é˜ˆå€¼: config.similarity_search.confidence_thresholds

ğŸ“Š ç›¸ä¼¼åº¦æœç´¢çš„å¢å¼ºä¿¡æ¯:
  - similarity_score: ä½™å¼¦ç›¸ä¼¼åº¦ [0, 1]
  - confidence: æ ¹æ® config.confidence_thresholds è‡ªåŠ¨åˆ¤æ–­
  - crop_path: æ–¹ä¾¿ç”¨æˆ·æŸ¥çœ‹å¯¹æ¯”å›¾åƒ
  - processing_time_ms: æ€§èƒ½ç›‘æ§
  - filtered_by_threshold: è¿‡æ»¤ç»Ÿè®¡

ğŸ”’ å¹¶å‘å®‰å…¨:
  - ä¸¤ä¸ªæ¨¡å‹ï¼ˆembedding + detectionï¼‰éƒ½æ˜¯å•ä¾‹
  - åœ¨ startup æ—¶åˆå§‹åŒ–ï¼Œæ°¸ä¸é‡æ–°åŠ è½½
  - æ¨¡å‹æ¨ç†ä½¿ç”¨ @torch.no_grad()
  - Storage I/O ä½¿ç”¨ threading.Lock ä¿æŠ¤
  - é…ç½®å¯¹è±¡å…¨å±€åªè¯»ï¼ˆå¯åŠ¨åä¸ä¿®æ”¹ï¼‰
  - å¼‚æ­¥ä»»åŠ¡ä¸å…±äº«å¯å˜çŠ¶æ€


7. å…³é”®è®¾è®¡è€ƒè™‘
================================================================================

âœ“ CPU ä¼˜åŒ–:
  - æ‰€æœ‰æ“ä½œéƒ½åœ¨ CPU ä¸Šï¼ˆæ—  GPUï¼‰
  - æ‰¹é‡æ¨ç†æå‡ååé‡ï¼ˆbatch_size=32ï¼‰
  - å‘é‡åŒ–ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆnumpy einsum æˆ– torch.mmï¼‰
  - å¼‚æ­¥ I/O ä¸é˜»å¡ embedding è®¡ç®—

âœ“ å†…å­˜ç®¡ç†:
  - æ¨¡å‹åœ¨å†…å­˜ä¸­æŒä¹…åŒ–ï¼ˆå•ä¾‹ï¼‰
  - åµŒå…¥å‘é‡å­˜å‚¨åœ¨ç£ç›˜ï¼ˆpklï¼‰ï¼Œéœ€è¦æ—¶åŠ è½½åˆ°å†…å­˜
  - å¤„ç†å¤§æ–‡ä»¶æ—¶ï¼Œæµå¼è¯»å–ï¼ˆä¸ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ï¼‰
  - ä¸´æ—¶å˜é‡åŠæ—¶é‡Šæ”¾

âœ“ é”™è¯¯å¤„ç†ä¸æ—¥å¿—ç³»ç»Ÿï¼ˆLoggerï¼‰:
  
  æ—¥å¿—æ¶æ„:
    â”œâ”€â”€ Logger çº§åˆ«é…ç½®
    â”‚   â”œâ”€â”€ DEBUG: è¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘é˜¶æ®µï¼‰
    â”‚   â”œâ”€â”€ INFO: æ­£å¸¸è¿è¡Œä¿¡æ¯ï¼ˆå¯åŠ¨ã€æ¨¡å‹åŠ è½½æˆåŠŸç­‰ï¼‰
    â”‚   â”œâ”€â”€ WARNING: è­¦å‘Šä¿¡æ¯ï¼ˆæ£€æµ‹åˆ° 0 ä¸ªå°ç« ã€ä½ç½®ä¿¡åº¦ç­‰ï¼‰
    â”‚   â”œâ”€â”€ ERROR: é”™è¯¯ä¿¡æ¯ï¼ˆæ–‡ä»¶è¯»å–å¤±è´¥ã€æ¨¡å‹è®¡ç®—å¼‚å¸¸ç­‰ï¼‰
    â”‚   â””â”€â”€ CRITICAL: ä¸¥é‡é”™è¯¯ï¼ˆå¯åŠ¨å¤±è´¥ã€æ¨¡å‹åŠ è½½å¤±è´¥ç­‰ï¼‰
    â”‚
    â”œâ”€â”€ æ—¥å¿—è¾“å‡ºç›®æ ‡
    â”‚   â”œâ”€â”€ æ§åˆ¶å°ï¼ˆConsole Handlerï¼‰ï¼šè¿è¡Œæ—¶å®æ—¶å±•ç¤º
    â”‚   â””â”€â”€ æ–‡ä»¶ï¼ˆFile Handlerï¼‰ï¼šlogs/seal_api_{date}.logï¼Œä¾¿äºäº‹ååˆ†æ
    â”‚
    â””â”€â”€ æ—¥å¿—æ ¼å¼
        â””â”€â”€ [%(asctime)s] [%(name)s] [%(levelname)s] %(message)s
            â†“
            [2026-01-27 12:00:45] [seal_api.core.embedding] [ERROR] Failed to extract embedding

  æ¨¡å—çº§æ—¥å¿—è®°å½•:
    â”œâ”€â”€ main.py
    â”‚   â””â”€â”€ è®°å½•å¯åŠ¨/å…³é—­ï¼Œæ¨¡å‹åŠ è½½çŠ¶æ€ï¼Œé…ç½®ä¿¡æ¯
    â”‚
    â”œâ”€â”€ config_loader.py
    â”‚   â””â”€â”€ è®°å½•é…ç½®åŠ è½½è¿‡ç¨‹ï¼Œå‚æ•°éªŒè¯ç»“æœ
    â”‚
    â”œâ”€â”€ api/health.py
    â”‚   â””â”€â”€ è®°å½•å¥åº·æ£€æŸ¥è¯·æ±‚ï¼Œæ¨¡å‹çŠ¶æ€
    â”‚
    â”œâ”€â”€ api/pipeline.py
    â”‚   â””â”€â”€ è®°å½•è¯·æ±‚æ¥æ”¶ï¼Œå¤„ç†è¿›åº¦ï¼Œæœ€ç»ˆç»“æœ
    â”‚       logger.info(f"[request_id={req_id}] Processing {len(images)} images")
    â”‚       logger.error(f"[request_id={req_id}] Detection failed: {e}")
    â”‚
    â”œâ”€â”€ core/detection_service.py
    â”‚   â””â”€â”€ è®°å½•æ£€æµ‹è¿‡ç¨‹ï¼Œæ£€æµ‹åˆ°çš„å°ç« æ•°é‡ï¼Œè€—æ—¶
    â”‚       logger.debug(f"Detected {len(seals)} seals from image")
    â”‚
    â”œâ”€â”€ core/embedding_service.py
    â”‚   â””â”€â”€ è®°å½• batch å¤„ç†ï¼Œembedding è®¡ç®—è€—æ—¶
    â”‚       logger.info(f"Extracted embeddings for batch of {len(images)} images")
    â”‚       logger.error(f"Embedding extraction failed for image {idx}: {e}")
    â”‚
    â”œâ”€â”€ core/storage.py
    â”‚   â””â”€â”€ è®°å½•å­˜å‚¨æ“ä½œï¼ŒI/O å¼‚å¸¸
    â”‚       logger.debug(f"Saved embedding {seal_id}")
    â”‚       logger.error(f"Failed to save embedding {seal_id}: {e}")
    â”‚
    â””â”€â”€ core/similarity_service.py
        â””â”€â”€ è®°å½•ç›¸ä¼¼åº¦è®¡ç®—ï¼Œæœç´¢ç»“æœ
            logger.info(f"Similarity search completed, found {len(results)} matches")

  é”™è¯¯å¤„ç†ç­–ç•¥:
    1. å›¾åƒè§£ç å¤±è´¥
       â†’ ERROR æ—¥å¿—ï¼Œè¿”å› HTTP 400 + è¯¦ç»†é”™è¯¯ä¿¡æ¯
       logger.error(f"Failed to decode image: {e}")
    
    2. æ£€æµ‹åˆ° 0 ä¸ªå°ç« 
       â†’ WARNING æ—¥å¿—ï¼Œè¿”å› HTTP 200 + seals_detected=0ï¼ˆæ­£å¸¸æµç¨‹ï¼‰
       logger.warning(f"No seals detected in document {doc_id}")
    
    3. æ¨¡å‹åŠ è½½å¤±è´¥
       â†’ CRITICAL æ—¥å¿—ï¼Œstartup å¤±è´¥ï¼Œserver æ— æ³•å¯åŠ¨
       logger.critical(f"Failed to load embedding model from {pkg_dir}: {e}")
    
    4. æ–‡ä»¶ I/O å¼‚å¸¸
       â†’ ERROR æ—¥å¿—ï¼Œè¿”å› HTTP 500ï¼Œä¿è¯ä¸€è‡´æ€§
       logger.error(f"Failed to write embedding file: {e}")
    
    5. ç½‘ç»œ/è¶…æ—¶å¼‚å¸¸
       â†’ ERROR æ—¥å¿—ï¼Œè¿”å› HTTP 408/504
       logger.error(f"Request timeout after {timeout}s")
    
    6. å¹¶å‘å¤„ç†å¼‚å¸¸
       â†’ ERROR æ—¥å¿—ï¼Œè®°å½•å…·ä½“å¤±è´¥çš„ batch ç´¢å¼•
       logger.error(f"Batch {batch_idx} processing failed: {e}")

  è¯·æ±‚è¿½è¸ªï¼ˆRequest IDï¼‰:
    - æ¯ä¸ªè¯·æ±‚ç”Ÿæˆå”¯ä¸€ request_idï¼ˆUUIDï¼‰
    - æ‰€æœ‰æ—¥å¿—éƒ½å¸¦ä¸Š request_idï¼Œä¾¿äºè¿½è¸ªå•ä¸ªè¯·æ±‚çš„å…¨ç”Ÿå‘½å‘¨æœŸ
    ç¤ºä¾‹:
      [2026-01-27 12:00:45] [api.pipeline] [INFO] [req_id=abc123] Received 5 images for processing
      [2026-01-27 12:00:46] [detection] [INFO] [req_id=abc123] Detected 12 seals total
      [2026-01-27 12:00:48] [embedding] [ERROR] [req_id=abc123] Batch 2 failed: CUDA out of memory
      [2026-01-27 12:00:48] [api.pipeline] [ERROR] [req_id=abc123] Pipeline failed with status 500

  æ—¥å¿—æŒä¹…åŒ–ä¸è½®è½¬:
    - æ—¥å¿—æ–‡ä»¶ä½ç½®: logs/seal_api_{YYYY-MM-DD}.log
    - ä½¿ç”¨ RotatingFileHandlerï¼Œæ¯å¤©ç”Ÿæˆæ–°æ–‡ä»¶
    - ä¿ç•™æœ€è¿‘ 30 å¤©çš„æ—¥å¿—
    - æ—¥å¿—å¤§å°è¶…è¿‡ 100MB æ—¶è‡ªåŠ¨è½®è½¬

âœ“ å¹¶å‘æ€§:
  - å¼‚æ­¥å¤„ç†å¤šä¸ªè¯·æ±‚ï¼ˆé«˜å¹¶å‘æ”¯æŒï¼‰
  - æ–‡ä»¶ä¸Šä¼ æ”¯æŒå¤šä¸ªæ–‡ä»¶å¹¶å‘
  - æ‰¹å¤„ç†å†…éƒ¨å¹¶å‘ï¼ˆå¤šä¸ª batch åŒæ—¶å¤„ç†ï¼‰
  - ä¸ä¼šå› ä¸ºä¸€ä¸ªè¯·æ±‚çš„å¤„ç†æ—¶é—´é•¿è€Œé˜»å¡å…¶ä»–è¯·æ±‚

âœ“ å¯æ‰©å±•æ€§:
  - åç»­å¯æ— ç¼æ¥å…¥çœŸå®æ•°æ®åº“ï¼ˆPostgreSQL + pgvectorï¼‰
  - å½“å‰å­˜å‚¨æ¥å£æ˜“äºæ›¿æ¢
  - å¯æ·»åŠ ç¼“å­˜å±‚ï¼ˆRedisï¼‰
  - å¯æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼ˆéœ€è¦å…±äº«å­˜å‚¨ï¼‰


8. å¼€å‘é¡ºåºå»ºè®®
================================================================================

Phase 1: åŸºç¡€æ¡†æ¶ + é…ç½®ç®¡ç† + æ—¥å¿—ç³»ç»Ÿ
  1. logger_config.py - æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–
  2. config/api_config.json - é…ç½®æ–‡ä»¶ï¼ˆåŒæ¨¡å‹å‚æ•°ï¼‰
  3. config_loader.py - é…ç½®åŠ è½½å™¨
  4. main.py - å¼‚æ­¥åº”ç”¨åˆå§‹åŒ–ã€åŒæ¨¡å‹åŠ è½½ã€æ—¥å¿—åˆå§‹åŒ–
  5. models.py - æ‰€æœ‰ Pydantic æ¨¡å‹
  6. core/storage.py - çº¿ç¨‹å®‰å…¨çš„å­˜å‚¨ï¼ˆå«æ—¥å¿—ï¼‰
  7. api/health.py - å¼‚æ­¥ health ç«¯ç‚¹ï¼ˆéªŒè¯åŒæ¨¡å‹ï¼Œå«æ—¥å¿—ï¼‰
  âœ“ å¯è¿è¡Œçš„æœ€å°åŒ–å¼‚æ­¥ API + å®Œæ•´æ—¥å¿—ç³»ç»Ÿ

Phase 2: Pipeline + æ–‡ä»¶ä¸Šä¼  + æ£€æµ‹æŒä¹…åŒ–
  8. core/detection_service.py - DetectionServiceï¼ˆæŒä¹…åŒ– LayoutDetectionï¼Œå«æ—¥å¿—ï¼‰
  9. core/embedding_service.py - EmbeddingServiceï¼ˆä» config è¯»å– batch_sizeï¼Œå«æ—¥å¿—ï¼‰
  10. api/pipeline.py - ingest_base64 / ingest_upload ç«¯ç‚¹ï¼ˆå«è¯·æ±‚è¿½è¸ª IDï¼Œå«æ—¥å¿—ï¼‰
  âœ“ å®Œæ•´çš„ç«¯åˆ°ç«¯å¼‚æ­¥å·¥ä½œæµ + è¯¦ç»†æ—¥å¿—è¿½è¸ª

Phase 3: ç›¸ä¼¼åº¦æœç´¢ + å¢å¼ºä¿¡æ¯
  11. core/similarity_service.py - å¼‚æ­¥ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆå«æ—¥å¿—ï¼‰
  12. api/pipeline.py - search ç«¯ç‚¹ï¼ˆå¢å¼ºè¿”å›ï¼Œå«æ—¥å¿—ï¼‰
  âœ“ å®Œæ•´çš„ä¸‰ä¸ªæ¥å£åŠŸèƒ½ + å…¨é¢æ—¥å¿—è¦†ç›–

Phase 4: æµ‹è¯•å’Œä¼˜åŒ–
  13. è´Ÿè½½æµ‹è¯•ï¼ˆå¹¶å‘ã€æ‰¹å¤„ç†æ€§èƒ½ï¼ŒéªŒè¯æ—¥å¿—è¾“å‡ºï¼‰
  14. æ–‡æ¡£å®Œå–„ï¼ˆOpenAPI/Swaggerï¼Œæ—¥å¿—è¯´æ˜ï¼‰
  15. Docker åŒ–ï¼ˆå¯é€‰ï¼Œå«æ—¥å¿—å·æŒ‚è½½ï¼‰

================================================================================

âœ… æœ€ç»ˆæ›´æ–°æ€»ç»“ï¼š

1. ğŸ¯ åŒæ¨¡å‹æŒä¹…åŒ–æ¶æ„
   - SealEmbeddingNetï¼ˆåµŒå…¥æå–ï¼‰
   - LayoutDetectionï¼ˆå°ç« æ£€æµ‹ï¼‰
   - ä¸¤ä¸ªæ¨¡å‹éƒ½åœ¨ startup æ—¶ä¸€æ¬¡æ€§åŠ è½½
   - æ°¸ä¹…é©»ç•™å†…å­˜ï¼Œæ— éœ€é‡å¤åŠ è½½

2. ğŸ“‹ é…ç½®é©±åŠ¨è®¾è®¡
   - config/api_config.json ä¸­å¿ƒé…ç½®æ–‡ä»¶
   - æ‰€æœ‰å‚æ•°ï¼ˆmodel_nameã€batch_sizeã€å¹¶å‘åº¦ç­‰ï¼‰éƒ½èµ°é…ç½®
   - æ— éœ€ä¿®æ”¹ä»£ç ï¼Œç›´æ¥è°ƒæ•´é…ç½®æ–‡ä»¶å³å¯æ”¹å˜è¡Œä¸º
   - ConfigLoader è´Ÿè´£è¯»å–å’ŒéªŒè¯é…ç½®

3. ï¿½ å®Œæ•´æ—¥å¿—ç³»ç»Ÿ â­ å…³é”®
   - æ¨¡å—çº§æ—¥å¿—è®°å½•ï¼ˆæ¯ä¸ªæ ¸å¿ƒæ¨¡å—éƒ½æœ‰ loggerï¼‰
   - è¯·æ±‚è¿½è¸ªï¼ˆrequest_idï¼‰ï¼Œä¾¿äºè¿½è¸ªå•ä¸ªè¯·æ±‚å…¨ç”Ÿå‘½å‘¨æœŸ
   - åˆ†çº§æ—¥å¿—ï¼ˆDEBUG/INFO/WARNING/ERROR/CRITICALï¼‰
   - æ—¥å¿—æŒä¹…åŒ–ï¼ˆæ–‡ä»¶ + æ§åˆ¶å°ï¼Œè‡ªåŠ¨è½®è½¬ï¼Œ30 å¤©ä¿ç•™ï¼‰
   - è¯¦ç»†é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ªï¼ˆä¾¿äºè°ƒè¯•å’Œäº‹ååˆ†æï¼‰
   - å·²åœ¨ç¬¬ 7 éƒ¨åˆ†"å…³é”®è®¾è®¡è€ƒè™‘"è¯¦ç»†è®¾è®¡

4. ğŸ” å‚æ•°ç®¡ç†æ¸…å•
   â”œâ”€â”€ embedding_model.pkg_dir        - SealEmbeddingNet æ¨¡å‹ä½ç½®
   â”œâ”€â”€ embedding_model.device         - è®¾å¤‡ï¼ˆcpu/cudaï¼‰
   â”œâ”€â”€ detection_model.model_name     - LayoutDetection æ¨¡å‹ï¼ˆS/M/Lï¼‰
   â”œâ”€â”€ detection_model.batch_size     - æ£€æµ‹ batch size
   â”œâ”€â”€ embedding_batch_size           - åµŒå…¥ batch sizeï¼ˆâ‰¤32ï¼‰
   â”œâ”€â”€ max_concurrent_tasks           - å¹¶å‘ batch æ•°
   â”œâ”€â”€ storage.base_dir               - å­˜å‚¨ç›®å½•
   â”œâ”€â”€ logs.level                     - æ—¥å¿—çº§åˆ«ï¼ˆDEBUG/INFO/WARNING/ERROR/CRITICALï¼‰
   â”œâ”€â”€ logs.file_path                 - æ—¥å¿—æ–‡ä»¶ä½ç½®
   â””â”€â”€ confidence_thresholds          - ç›¸ä¼¼åº¦ç­‰çº§é˜ˆå€¼

5. ğŸš€ å¯åŠ¨æµç¨‹ç®€åŒ–
   App Startup â†’ åˆå§‹åŒ–æ—¥å¿— â†’ ConfigLoader â†’ åŠ è½½ 2 ä¸ªæ¨¡å‹ â†’ åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡ â†’ å‡†å¤‡å°±ç»ª
   ï¼ˆæ— éœ€é‡å¤åˆå§‹åŒ–ï¼Œæ— éœ€å‚æ•°ç¡¬ç¼–ç ï¼Œå®Œæ•´æ—¥å¿—è®°å½•ï¼‰

6. ğŸ”’ ç”Ÿäº§çº§è´¨é‡
   - æ¨¡å‹å•ä¾‹ç®¡ç†ï¼ˆé¿å…é‡å¤åŠ è½½ï¼‰
   - çº¿ç¨‹å®‰å…¨çš„å¹¶å‘å¤„ç†
   - é…ç½®é›†ä¸­ç®¡ç†
   - å®Œæ•´çš„æ—¥å¿—è¿½è¸ªå’Œé”™è¯¯è®°å½•
   - æ˜“äºç›‘æ§å’Œè°ƒè¯•

7. ğŸ“Š è°ƒè¯•å‹å¥½
   - è¯·æ±‚çº§åˆ«çš„æ—¥å¿—è¿½è¸ªï¼ˆrequest_idï¼‰
   - è¯¦ç»†çš„é”™è¯¯å †æ ˆä¿¡æ¯
   - æ€§èƒ½æŒ‡æ ‡è®°å½•ï¼ˆå¤„ç†æ—¶é—´ç­‰ï¼‰
   - æ—¥å¿—æ–‡ä»¶ä¿ç•™ 30 å¤©ï¼Œä¾¿äºäº‹ååˆ†æ

âœ… å·²ç¡®è®¤æ­¤æœ€ç»ˆè®¾è®¡åŒ…æ‹¬å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿï¼Œå‡†å¤‡å¼€å§‹å®ç°ä»£ç ï¼

